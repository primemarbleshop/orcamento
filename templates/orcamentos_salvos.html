<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or√ßamentos Salvos</title>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>



    <h1>Or√ßamentos Salvos</h1>

<div class="filtros-container">
    <label for="filtro_codigo">C√≥digo:</label>
    <input type="text" id="filtro_codigo" placeholder="Digite o c√≥digo..." onkeyup="filtrarCodigo()">

    {% if session.get('admin') %}
    <label for="filtro_criado_por">Criado Por:</label>
    <select id="filtro_criado_por" onchange="filtrarCriadoPor()">
        <option value="Todos">Todos</option>
        {% for usuario in usuarios %}
            <option value="{{ usuario.nome }}">{{ usuario.nome }}</option>
        {% endfor %}
    </select>
    {% endif %}

    <!-- üîπ Cliente agora aparece para todos os usu√°rios -->
    <label for="filtro_cliente">Cliente:</label>
    <select id="filtro_cliente" onchange="filtrarCliente()">
    <option value="Todos">Todos</option>
    {% for cliente in clientes|sort(attribute='nome') %}
        {% if session.get('admin') or cliente.dono == session.get('user_cpf') %}
            <option value="{{ cliente.nome }}">{{ cliente.nome }}</option>
        {% endif %}
    {% endfor %}
</select>
  <label for="filtro_status">Status:</label>
<select id="filtro_status" onchange="filtrarTabela()">
    <option value="Todos">Todos</option>
    <option value="Em Espera">Em Espera</option>
    <option value="Aprovado">Aprovado</option>
    <option value="Declinado">Declinado</option>
</select>

<label for="filtro_tipo_cliente">Tipo Cliente:</label>
<select id="filtro_tipo_cliente" onchange="filtrarTabela()">
    <option value="Todos">Todos</option>
    <option value="Cliente de Porta">Cliente de Porta</option>
    <option value="Carteira de Cliente">Carteira de Cliente</option>
    <option value="Trafego Pago Google">Trafego Pago Google</option>
    <option value="Trafego Pago Meta">Trafego Pago Meta</option>
    <option value="Indica√ß√£o Arquiteto">Indica√ß√£o Arquiteto</option>
    <option value="Indica√ß√£o Construtor">Indica√ß√£o Construtor</option>
    <option value="Indica√ß√£o Cliente">Indica√ß√£o Cliente</option>
    <option value="Indica√ß√£o Marcenaria">Indica√ß√£o Marcenaria</option>
</select>

<label for="filtro_quantidade">Exibir √∫ltimos:</label>
<select id="filtro_quantidade" onchange="filterOrcamentos()">
    <option value="15">15</option>
    <option value="30">30</option>
    <option value="50">50</option>
    <option value="100">100</option>
    <option value="all">Todos</option>
</select>
	
</div>

</br>


    <table>
    <thead>
        <tr>
            <th>C√≥digo</th>
            {% if session.get('admin') %} <!-- Somente para administradores -->
                <th>Criado Por</th>
            {% endif %}
            <th>Cliente</th>
            <th>Data</th>
            <th>Valor Total</th>
            <th>Status</th>
            <th>Tipo Cliente</th>
            <th>A√ß√µes</th>
        </tr>
    </thead>
    <tbody id="orcamento_table">
    {% for orcamento in orcamentos %}
    <tr 
        data-codigo="{{ orcamento.codigo | lower }}"
        data-cliente="{{ orcamento.cliente_nome }}"
    >
        <td>{{ orcamento.codigo }}</td>
        {% if session.get('admin') %}
            <td>{{ orcamento.criado_por }}</td>
        {% endif %}
        <td>{{ orcamento.cliente_nome }}</td>
        <td>{{ orcamento.data_salvo.strftime('%d/%m/%Y') }}</td>
        <td>R$ {{ "%.2f"|format(orcamento.valor_total) }}</td>
    <td>
                <select class="status-select">
                    <option value="Em Espera" {% if orcamento.status == "Em Espera" %}selected{% endif %}>Em Espera</option>
                    <option value="Aprovado" {% if orcamento.status == "Aprovado" %}selected{% endif %}>Aprovado</option>
                    <option value="Declinado" {% if orcamento.status == "Declinado" %}selected{% endif %}>Declinado</option>
                </select>
            </td>

            <!-- üîπ Tipo Cliente como Lista Suspensa -->
            <td>
                <select class="tipo-cliente-select">
                    <option value="Selecionar" {% if not orcamento.tipo_cliente or orcamento.tipo_cliente == "Selecionar" %}selected{% endif %}>Selecionar</option>
                    <option value="Cliente de Porta" {% if orcamento.tipo_cliente == "Cliente de Porta" %}selected{% endif %}>Cliente de Porta</option>
                    <option value="Carteira de Cliente" {% if orcamento.tipo_cliente == "Carteira de Cliente" %}selected{% endif %}>Carteira de Cliente</option>
                    <option value="Trafego Pago Google" {% if orcamento.tipo_cliente == "Trafego Pago Google" %}selected{% endif %}>Trafego Pago Google</option>
                    <option value="Trafego Pago Meta" {% if orcamento.tipo_cliente == "Trafego Pago Meta" %}selected{% endif %}>Trafego Pago Meta</option>
                    <option value="Indica√ß√£o Arquiteto" {% if orcamento.tipo_cliente == "Indica√ß√£o Arquiteto" %}selected{% endif %}>Indica√ß√£o Arquiteto</option>
                    <option value="Indica√ß√£o Construtor" {% if orcamento.tipo_cliente == "Indica√ß√£o Construtor" %}selected{% endif %}>Indica√ß√£o Construtor</option>
                    <option value="Indica√ß√£o Cliente" {% if orcamento.tipo_cliente == "Indica√ß√£o Cliente" %}selected{% endif %}>Indica√ß√£o Cliente</option>
                    <option value="Indica√ß√£o Marcenaria" {% if orcamento.tipo_cliente == "Indica√ß√£o Marcenaria" %}selected{% endif %}>Indica√ß√£o Marcenaria</option>
                </select>
            </td>

        <td>

            <button class="btn-visualizar" data-url="{{ url_for('detalhes_orcamento_salvo', codigo=orcamento.codigo) }}">Visualizar</button>
	    <button class="btn-salvar" data-id="{{ orcamento.id }}">Salvar</button>
            <button class="btn-deletar" data-id="{{ orcamento.id }}">Deletar</button>
        </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>

</br>
</br>


    <a href="/">Voltar para a P√°gina Inicial</a>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Bibliotecas do Select2 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

	
<script>


document.addEventListener("DOMContentLoaded", function() {

    // üîπ A√ß√£o para o bot√£o "Visualizar"
    document.querySelectorAll(".btn-visualizar").forEach(button => {
        button.addEventListener("click", function() {
            let url = this.getAttribute("data-url");
            if (url) {
                window.location.href = url;
            } else {
                Swal.fire("Erro!", "URL inv√°lida para visualiza√ß√£o.", "error");
            }
        });
    });

    // üîπ A√ß√£o para o bot√£o "Deletar" com SweetAlert2
    document.querySelectorAll(".btn-deletar").forEach(button => {
        button.addEventListener("click", function() {
            let orcamentoId = this.getAttribute("data-id");

            if (!orcamentoId) {
                Swal.fire("Erro!", "ID do or√ßamento n√£o encontrado.", "error");
                return;
            }

            Swal.fire({
                title: "Tem certeza?",
                text: "Essa a√ß√£o n√£o pode ser desfeita!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Sim, deletar!",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/deletar_orcamento_salvo/${orcamentoId}`, {
                        method: "POST"
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "Deletado!",
                                text: "O or√ßamento foi exclu√≠do com sucesso.",
                                icon: "success",
                                timer: 2000,
                                showConfirmButton: false
                            });
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            Swal.fire("Erro!", "N√£o foi poss√≠vel excluir o or√ßamento.", "error");
                        }
                    })
                    .catch(() => {
                        Swal.fire("Erro!", "Erro na comunica√ß√£o com o servidor.", "error");
                    });
                }
            });
        });
    });

});

// üîπ Fun√ß√£o principal que aplica todos os filtros
function filterOrcamentos() {
    const codigoBusca = document.getElementById("filtro_codigo")?.value.trim().toLowerCase() || "";
    const criadoPorSelecionado = document.getElementById("filtro_criado_por")?.value || "Todos";
    const clienteSelecionado = document.getElementById("filtro_cliente")?.value || "Todos";
    const statusSelecionado = document.getElementById("filtro_status")?.value || "Todos";
    const tipoClienteSelecionado = document.getElementById("filtro_tipo_cliente")?.value || "Todos";
    const filtroQuantidadeValue = document.getElementById("filtro_quantidade")?.value || "all";

    const linhasTabela = Array.from(document.querySelectorAll("#orcamento_table tr"));

    // Primeiro aplica todos os filtros "normais"
    linhasTabela.forEach(linha => {
        const codigo = linha.querySelector("td:nth-child(1)")?.textContent.trim().toLowerCase() || "";
        const criadoPor = linha.querySelector("td:nth-child(2)")?.textContent.trim() || "";
        const cliente = linha.getAttribute("data-cliente")?.trim() || "";
        const status = linha.querySelector(".status-select")?.value.trim() || "";
        const tipoCliente = linha.querySelector(".tipo-cliente-select")?.value.trim() || "";

        let exibir = true;

        if (codigoBusca && !codigo.includes(codigoBusca)) exibir = false;
        if (criadoPorSelecionado !== "Todos" && criadoPor !== criadoPorSelecionado) exibir = false;
        if (clienteSelecionado !== "Todos" && cliente !== clienteSelecionado) exibir = false;
        if (statusSelecionado !== "Todos" && status !== statusSelecionado) exibir = false;
        if (tipoClienteSelecionado !== "Todos" && tipoCliente !== tipoClienteSelecionado) exibir = false;

        linha.style.display = exibir ? "" : "none";
    });

    // Agora aplica o filtro de quantidade (mant√©m apenas os primeiros N vis√≠veis)
    if (filtroQuantidadeValue !== "all") {
        const limite = parseInt(filtroQuantidadeValue);
        const linhasVisiveis = linhasTabela.filter(linha => linha.style.display !== "none");

        linhasVisiveis.forEach((linha, index) => {
            linha.style.display = (index < limite) ? "" : "none";
        });
    }
}

// üîπ Salvar e restaurar filtros do LocalStorage
document.addEventListener("DOMContentLoaded", function () {
    const filtros = ["filtro_codigo", "filtro_criado_por", "filtro_cliente", "filtro_status", "filtro_tipo_cliente", "filtro_quantidade"];

    filtros.forEach(id => {
        const elem = document.getElementById(id);
        if (elem && localStorage.getItem(id)) {
            elem.value = localStorage.getItem(id);
        }
        if (elem) {
            elem.addEventListener("change", function () {
                localStorage.setItem(id, this.value);
                filterOrcamentos();
            });
        }
    });

    // Aplica os filtros ao carregar
    filterOrcamentos();
});

// üîπ Bot√£o salvar (atualizar status e tipo cliente)
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".btn-salvar").forEach(button => {
        button.addEventListener("click", function() {
            let orcamentoId = this.getAttribute("data-id");
            let linha = this.closest("tr");
            let status = linha.querySelector(".status-select").value;
            let tipoCliente = linha.querySelector(".tipo-cliente-select").value;

            fetch("/atualizar_status_tipo_cliente", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: orcamentoId,
                    status: status,
                    tipo_cliente: tipoCliente
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("Sucesso!", "Or√ßamento atualizado com sucesso!", "success");
                } else {
                    Swal.fire("Erro!", data.error, "error");
                }
            })
            .catch(() => {
                Swal.fire("Erro!", "Erro na comunica√ß√£o com o servidor.", "error");
            });
        });
    });
});

// üîπ Select2 no filtro de cliente
$(document).ready(function() {
    $('#filtro_cliente').select2({
        placeholder: "Selecione um cliente",
        allowClear: true,
        width: 'resolve'
    });

    $('#filtro_cliente').on('change', function() {
        filterOrcamentos();
        $(this).select2('close');
    });
});






</script>

</body>
</html>
