<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or칞amentos Salvos</title>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>



    <h1>Or칞amentos Salvos</h1>

<div class="filtros-container">
    <label for="filtro_codigo">C칩digo:</label>
    <input type="text" id="filtro_codigo" placeholder="Digite o c칩digo..." onkeyup="filtrarCodigo()">

    {% if session.get('admin') %}
    <label for="filtro_criado_por">Criado Por:</label>
    <select id="filtro_criado_por" onchange="filtrarCriadoPor()">
        <option value="Todos">Todos</option>
        {% for usuario in usuarios %}
            <option value="{{ usuario.nome }}">{{ usuario.nome }}</option>
        {% endfor %}
    </select>
    {% endif %}

    <!-- 游댳 Cliente agora aparece para todos os usu치rios -->
    <label for="filtro_cliente">Cliente:</label>
    <select id="filtro_cliente" onchange="filtrarCliente()">
        <option value="Todos">Todos</option>
        {% for cliente in clientes %}
            {% if session.get('admin') or cliente.dono == session.get('user_cpf') %}
                <option value="{{ cliente.nome }}">{{ cliente.nome }}</option>
            {% endif %}
        {% endfor %}
    </select>
  <label for="filtro_status">Status:</label>
<select id="filtro_status" onchange="filtrarTabela()">
    <option value="Todos">Todos</option>
    <option value="Em Espera">Em Espera</option>
    <option value="Aprovado">Aprovado</option>
    <option value="Declinado">Declinado</option>
</select>

<label for="filtro_tipo_cliente">Tipo Cliente:</label>
<select id="filtro_tipo_cliente" onchange="filtrarTabela()">
    <option value="Todos">Todos</option>
    <option value="Cliente de Porta">Cliente de Porta</option>
    <option value="Carteira de Cliente">Carteira de Cliente</option>
    <option value="Trafego Pago Google">Trafego Pago Google</option>
    <option value="Trafego Pago Meta">Trafego Pago Meta</option>
    <option value="Indica칞칚o Arquiteto">Indica칞칚o Arquiteto</option>
    <option value="Indica칞칚o Construtor">Indica칞칚o Construtor</option>
    <option value="Indica칞칚o Cliente">Indica칞칚o Cliente</option>
    <option value="Indica칞칚o Marcenaria">Indica칞칚o Marcenaria</option>
</select>

</div>

</br>


    <table>
    <thead>
        <tr>
            <th>C칩digo</th>
            {% if session.get('admin') %} <!-- Somente para administradores -->
                <th>Criado Por</th>
            {% endif %}
            <th>Cliente</th>
            <th>Data</th>
            <th>Valor Total</th>
            <th>Status</th>
            <th>Tipo Cliente</th>
            <th>A칞칫es</th>
        </tr>
    </thead>
    <tbody id="orcamento_table">
    {% for orcamento in orcamentos %}
    <tr 
        data-codigo="{{ orcamento.codigo | lower }}"
        data-cliente="{{ orcamento.cliente_nome }}"
    >
        <td>{{ orcamento.codigo }}</td>
        {% if session.get('admin') %}
            <td>{{ orcamento.criado_por }}</td>
        {% endif %}
        <td>{{ orcamento.cliente_nome }}</td>
        <td>{{ orcamento.data_salvo.strftime('%d/%m/%Y') }}</td>
        <td>R$ {{ "%.2f"|format(orcamento.valor_total) }}</td>
    <td>
                <select class="status-select">
                    <option value="Em Espera" {% if orcamento.status == "Em Espera" %}selected{% endif %}>Em Espera</option>
                    <option value="Aprovado" {% if orcamento.status == "Aprovado" %}selected{% endif %}>Aprovado</option>
                    <option value="Declinado" {% if orcamento.status == "Declinado" %}selected{% endif %}>Declinado</option>
                </select>
            </td>

            <!-- 游댳 Tipo Cliente como Lista Suspensa -->
            <td>
                <select class="tipo-cliente-select">
                    <option value="Selecionar" {% if not orcamento.tipo_cliente or orcamento.tipo_cliente == "Selecionar" %}selected{% endif %}>Selecionar</option>
                    <option value="Cliente de Porta" {% if orcamento.tipo_cliente == "Cliente de Porta" %}selected{% endif %}>Cliente de Porta</option>
                    <option value="Carteira de Cliente" {% if orcamento.tipo_cliente == "Carteira de Cliente" %}selected{% endif %}>Carteira de Cliente</option>
                    <option value="Trafego Pago Google" {% if orcamento.tipo_cliente == "Trafego Pago Google" %}selected{% endif %}>Trafego Pago Google</option>
                    <option value="Trafego Pago Meta" {% if orcamento.tipo_cliente == "Trafego Pago Meta" %}selected{% endif %}>Trafego Pago Meta</option>
                    <option value="Indica칞칚o Arquiteto" {% if orcamento.tipo_cliente == "Indica칞칚o Arquiteto" %}selected{% endif %}>Indica칞칚o Arquiteto</option>
                    <option value="Indica칞칚o Construtor" {% if orcamento.tipo_cliente == "Indica칞칚o Construtor" %}selected{% endif %}>Indica칞칚o Construtor</option>
                    <option value="Indica칞칚o Cliente" {% if orcamento.tipo_cliente == "Indica칞칚o Cliente" %}selected{% endif %}>Indica칞칚o Cliente</option>
                    <option value="Indica칞칚o Marcenaria" {% if orcamento.tipo_cliente == "Indica칞칚o Marcenaria" %}selected{% endif %}>Indica칞칚o Marcenaria</option>
                </select>
            </td>

        <td>

            <button class="btn-visualizar" data-url="{{ url_for('detalhes_orcamento_salvo', codigo=orcamento.codigo) }}">Visualizar</button>
	    <button class="btn-salvar" data-id="{{ orcamento.id }}">Salvar</button>
            <button class="btn-deletar" data-id="{{ orcamento.id }}">Deletar</button>
        </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>

</br>
</br>


    <a href="/">Voltar para a P치gina Inicial</a>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>
</br>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>



document.addEventListener("DOMContentLoaded", function() {

    // 游댳 A칞칚o para o bot칚o "Visualizar"
    document.querySelectorAll(".btn-visualizar").forEach(button => {
        button.addEventListener("click", function() {
            let url = this.getAttribute("data-url");
            if (url) {
                window.location.href = url;
            } else {
                Swal.fire("Erro!", "URL inv치lida para visualiza칞칚o.", "error");
            }
        });
    });

    // 游댳 A칞칚o para o bot칚o "Deletar" com SweetAlert2
    document.querySelectorAll(".btn-deletar").forEach(button => {
        button.addEventListener("click", function() {
            let orcamentoId = this.getAttribute("data-id");

            if (!orcamentoId) {
                Swal.fire("Erro!", "ID do or칞amento n칚o encontrado.", "error");
                return;
            }

            Swal.fire({
                title: "Tem certeza?",
                text: "Essa a칞칚o n칚o pode ser desfeita!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Sim, deletar!",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/deletar_orcamento_salvo/${orcamentoId}`, {
                        method: "POST"
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "Deletado!",
                                text: "O or칞amento foi exclu칤do com sucesso.",
                                icon: "success",
                                timer: 2000,
                                showConfirmButton: false
                            });
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            Swal.fire("Erro!", "N칚o foi poss칤vel excluir o or칞amento.", "error");
                        }
                    })
                    .catch(() => {
                        Swal.fire("Erro!", "Erro na comunica칞칚o com o servidor.", "error");
                    });
                }
            });
        });
    });

});

function filtrarCodigo() {
    const codigoBusca = document.getElementById("filtro_codigo").value.trim().toLowerCase();
    const linhasTabela = document.querySelectorAll("#orcamento_table tr");

    linhasTabela.forEach(linha => {
        const codigo = linha.querySelector("td:nth-child(1)")?.textContent.trim().toLowerCase() || "";
        linha.style.display = codigo.includes(codigoBusca) ? "" : "none";
    });
}
function filtrarCriadoPor() {
    const criadoPorSelecionado = document.getElementById("filtro_criado_por").value;
    const linhasTabela = document.querySelectorAll("#orcamento_table tr");

    linhasTabela.forEach(linha => {
        const criadoPor = linha.querySelector("td:nth-child(2)")?.textContent.trim() || "";
        linha.style.display = (criadoPorSelecionado === "Todos" || criadoPor === criadoPorSelecionado) ? "" : "none";
    });
}

document.addEventListener("DOMContentLoaded", function () {

    function filtrarCliente() {
        const clienteSelecionado = document.getElementById("filtro_cliente").value;
        const linhasTabela = document.querySelectorAll("#orcamento_table tr");

        linhasTabela.forEach(linha => {
            const cliente = linha.getAttribute("data-cliente").trim();

            let exibir = true;

            if (clienteSelecionado !== "Todos" && cliente !== clienteSelecionado) {
                exibir = false;
            }

            linha.style.display = exibir ? "" : "none";
        });
    }

    document.getElementById("filtro_cliente").addEventListener("change", filtrarCliente);
});


function filtrarTabela() {
    const statusSelecionado = document.getElementById("filtro_status").value;
    const tipoClienteSelecionado = document.getElementById("filtro_tipo_cliente").value;
    const linhasTabela = document.querySelectorAll("#orcamento_table tr");

    linhasTabela.forEach(linha => {
        const status = linha.querySelector(".status-select").value.trim(); // Pega o valor do select
        const tipoCliente = linha.querySelector(".tipo-cliente-select").value.trim(); // Pega o valor do select

        let exibir = true;

        if (statusSelecionado !== "Todos" && status !== statusSelecionado) {
            exibir = false;
        }
        if (tipoClienteSelecionado !== "Todos" && tipoCliente !== tipoClienteSelecionado) {
            exibir = false;
        }

        linha.style.display = exibir ? "" : "none";
    });
}

// Eventos para filtrar ao mudar os selects
document.getElementById("filtro_status").addEventListener("change", filtrarTabela);
document.getElementById("filtro_tipo_cliente").addEventListener("change", filtrarTabela);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".btn-salvar").forEach(button => {
        button.addEventListener("click", function() {
            let orcamentoId = this.getAttribute("data-id");
            let linha = this.closest("tr"); // Pegamos a linha correta
            let status = linha.querySelector(".status-select").value; // Pegando o valor selecionado
            let tipoCliente = linha.querySelector(".tipo-cliente-select").value; // Pegando o valor selecionado

            fetch("/atualizar_status_tipo_cliente", {  // Nome da nova rota
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: orcamentoId,
                    status: status,
                    tipo_cliente: tipoCliente
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("Sucesso!", "Or칞amento atualizado com sucesso!", "success");
                } else {
                    Swal.fire("Erro!", data.error, "error");
                }
            })
            .catch(() => {
                Swal.fire("Erro!", "Erro na comunica칞칚o com o servidor.", "error");
            });
        });
    });
});




</script>

</body>
</html>
